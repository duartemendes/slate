<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Traffic Splitter</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;node.js&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="images/logo.png" alt="Logo" />
        <div class="lang-selector">
              <a href="#" data-language-name="node.js">node.js</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
            <li><a target='_blank' href='https://www.npmjs.com/package/traffic-splitter'>npm</a></li>
            <li><a target='_blank' href='https://github.com/Mindera/traffic-splitter'>GitHub</a></li>
            <li><a target='_blank' href='https://www.mindera.com/'>Mindera</a></li>
            <li><a target='_blank' href='https://github.com/tripit/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        
          <h1 id="introduction">Introduction</h1>

<p>Traffic Splitter is a component that allows for HTTP traffic to be directed to an appropriate upstream depending on the request matching certain criteria.</p>

<p><br></p>

<p>How it really works? It&rsquo;s not magic&hellip;</p>

<p><img src="images/architecture.png" alt="traffic-splitter-architecture" /></p>

          <h1 id="getting-started">Getting started</h1>

<p>There are two ways you can use this package and both need to be provided with a configuration.</p>

<p>Personalize your own <a href="#configuration">configuration</a> or go <a href="#ready-to-go-configuration">here</a> for a sample.</p>

<h3 id="cli">CLI</h3>

<aside class="notice">npm i traffic-splitter -g</aside>
<pre class="highlight javascript tab-javascript"><code><span class="c1">// in case config is a js file wrap it in:</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre>
<aside class="notice">traffic-splitter -c configuration.js</aside>

<p>Provided configuration can be a json or a js file.</p>

<p><br></p>

<h3 id="api">API</h3>

<aside class="notice">npm i traffic-splitter</aside>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">TrafficSplitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'traffic-splitter'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">splitter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TrafficSplitter</span><span class="p">(</span><span class="cm">/*your configuration*/</span><span class="p">)</span>
<span class="nx">splitter</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
</code></pre>
<p>Import the package.</p>

<p>Create an instance providing a configuration object.</p>

<p>Start it!</p>

<p><br>
<br>
<br></p>

<p>And BOOM, splitter is running!</p>

<aside class="success">localhost:PORT/healthcheck</aside>

          <h1 id="example">Example</h1>
<pre class="highlight javascript tab-javascript"><code><span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"mindera.com 0-50"</span><span class="p">,</span>
    <span class="s2">"enabled"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s2">"criteria"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"in"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"bucket"</span><span class="p">:</span> <span class="p">[{</span> <span class="s2">"min"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="s2">"max"</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}]</span>
      <span class="p">},</span>
      <span class="s2">"out"</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">"cookie"</span><span class="p">:</span> <span class="p">[{</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"keepme"</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"out"</span> <span class="p">}]</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">"upstream"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"serveSecure"</span><span class="p">,</span>
      <span class="s2">"options"</span><span class="p">:</span> <span class="p">{</span> <span class="s2">"host"</span><span class="p">:</span> <span class="s2">"www.mindera.com"</span><span class="p">,</span> <span class="s2">"port"</span><span class="p">:</span> <span class="mi">443</span><span class="p">,</span> <span class="s2">"headers"</span><span class="p">:</span> <span class="p">{</span> <span class="s2">"host"</span><span class="p">:</span> <span class="s2">"www.mindera.com"</span> <span class="p">}</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"npmjs.com 51-100"</span><span class="p">,</span>
    <span class="s2">"enabled"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s2">"criteria"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"in"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"bucket"</span><span class="p">:</span> <span class="p">[{</span> <span class="s2">"min"</span><span class="p">:</span> <span class="mi">51</span><span class="p">,</span>  <span class="s2">"max"</span><span class="p">:</span> <span class="mi">100</span> <span class="p">}]</span>
      <span class="p">},</span>
      <span class="s2">"out"</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">},</span>
    <span class="s2">"upstream"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"serveSecure"</span><span class="p">,</span>
      <span class="s2">"options"</span><span class="p">:</span> <span class="p">{</span> <span class="s2">"host"</span><span class="p">:</span> <span class="s2">"www.npmjs.com"</span><span class="p">,</span> <span class="s2">"port"</span><span class="p">:</span> <span class="mi">443</span><span class="p">,</span> <span class="s2">"headers"</span><span class="p">:</span> <span class="p">{</span> <span class="s2">"host"</span><span class="p">:</span> <span class="s2">"www.npmjs.com"</span> <span class="p">}</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre>
<p>This upstreams example splits the traffic between mindera.com and npmjs.com, each one will handle 50% of the traffic.</p>

<p><br></p>

<p><strong>The object &ldquo;in&rdquo; inside the criteria contains all the criteria (don&rsquo;t worry, you&rsquo;ll learn all about this in a few moments) that need to be respected in order for that upstream to be selected. The same goes for the &ldquo;out&rdquo; object but instead, it eliminates that upstream from being chosen.</strong></p>

<p><br></p>

<p>For instance, if the user has a cookie named &ldquo;keepme&rdquo; with the value &ldquo;out&rdquo;, he won&rsquo;t ever be served with the mindera&rsquo;s upstream. Why? Because mindera&rsquo;s upstream has a cookie rule (that matches) inside the &ldquo;out&rdquo; object.</p>

<p><br></p>

<p>Also, upstreams can be enabled or disabled by changing the &ldquo;enabled&rdquo; property.</p>

<p><br></p>

<p>&ldquo;Wow.. this is the real thing! What other type of upstreams are available?&rdquo;</p>

<p>Just scroll down a bit and you&rsquo;ll find out :p</p>

          <h1 id="upstream-types">Upstream types</h1>

<h2 id="serve">Serve</h2>
<pre class="highlight javascript tab-javascript"><code><span class="p">{</span>
  <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"serve"</span><span class="p">,</span>
  <span class="s2">"options"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"host"</span><span class="p">:</span> <span class="s2">"www.sapo.pt"</span><span class="p">,</span>
    <span class="s2">"port"</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
    <span class="s2">"timeout"</span><span class="p">:</span> <span class="mi">6000</span><span class="p">,</span>
    <span class="s2">"headers"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"host"</span><span class="p">:</span> <span class="s2">"www.sapo.pt"</span>
    <span class="p">},</span>
    <span class="s2">"rewrite"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"expression"</span><span class="p">:</span> <span class="s2">"(.*)"</span><span class="p">,</span>
      <span class="s2">"to"</span><span class="p">:</span> <span class="s2">"/noticias/"</span>
    <span class="p">},</span>
    <span class="s2">"cookies"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"flavour"</span><span class="p">:</span> <span class="p">{</span> <span class="s2">"maxAge"</span><span class="p">:</span> <span class="mi">60000</span><span class="p">,</span> <span class="s2">"domain"</span><span class="p">:</span> <span class="s2">"localhost"</span><span class="p">,</span> <span class="s2">"path"</span><span class="p">:</span> <span class="s2">"/"</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"chocolate"</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>It proxies the traffic to a non-certified host.</p>

<p>Host and port must be defined.</p>

<h3 id="optional-configuration">Optional configuration</h3>

<p><strong>timeout</strong> - sets the proxy timeout</p>

<p><strong>headers</strong> - adds and overrides existing ones to be sent upstream, meaning that these headers will be sent to the server where the request is being proxied to</p>

<p><strong>rewrite</strong> - rewrites the path of the request by providing a regular expression &ldquo;expression&rdquo; and a replacement string &ldquo;to&rdquo;. In the given example the url will be what the user has requested but it will always respond for the &ldquo;/noticias/&rdquo; path</p>

<p><strong>cookies</strong> - adds and overrides existing ones to be sent both for upstream and downstream, meaning that these cookies will be sent to the server where the request is being proxied to and it will also be included in the response (potentially overriding a cookie being set by the upstream server)</p>

<h2 id="serve-secure">Serve secure</h2>
<pre class="highlight javascript tab-javascript"><code><span class="p">{</span>
  <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"serveSecure"</span><span class="p">,</span>
  <span class="s2">"options"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"host"</span><span class="p">:</span> <span class="s2">"www.mindera.com"</span><span class="p">,</span>
    <span class="s2">"port"</span><span class="p">:</span> <span class="mi">443</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>It proxies the traffic to a certified host.</p>

<p>Host and port must also be defined.</p>

<p><br></p>

<p><strong>Optional configuration</strong> is extended from the <a href="#serve">serve</a> type.</p>

<h2 id="redirect">Redirect</h2>
<pre class="highlight javascript tab-javascript"><code><span class="p">{</span>
  <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"redirect"</span><span class="p">,</span>
  <span class="s2">"options"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"location"</span><span class="p">:</span> <span class="s2">"https://mindera.com/blog"</span><span class="p">,</span>
    <span class="s2">"statusCode"</span><span class="p">:</span> <span class="mi">302</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>It responds to the original request with a redirect response containing the given location and status code.</p>

<p>In this case, when a request to localhost is made, the user will be redirected to &ldquo;https://mindera.com/blog&rdquo;.</p>

          <h1 id="criteria">Criteria</h1>

<p>As shown in the <a href="#example">example</a>, criteria has two properties: &ldquo;in&rdquo; and &ldquo;out&rdquo;.</p>

<p>Those properties are objects that contains rules that will be evaluated against the request made.</p>
<pre class="highlight javascript tab-javascript"><code><span class="p">{</span>
  <span class="s2">"path"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"/home"</span><span class="p">,</span> <span class="s2">"/about"</span><span class="p">,</span> <span class="s2">"/blog"</span><span class="p">]</span>
<span class="p">}</span>
</code></pre>
<p>There are quite a few default rules at your disposal, check below. These rules are arrays that may contain n elements and only one of them needs to be true for the condition to be true as well. Check the given example: the request can only have one path, so for the condition to be valid that path needs to match one of the given paths.</p>

<p><br></p>

<p>Oh, and you can also add your custom rules in a very easy and smooth way! (wait&hellip; what?) Yeah, it&rsquo;s <a href="#addrule">true</a>!</p>

<h2 id="agent">agent</h2>
<pre class="highlight javascript tab-javascript"><code><span class="s2">"agent"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Chrome"</span><span class="p">,</span> <span class="s2">"Safari"</span><span class="p">,</span> <span class="s2">"Opera"</span><span class="p">]</span>
</code></pre>
<p>Evaluates against the user-agent header.</p>

<p>If no such header is provided the condition wont ever be met.</p>

<h2 id="bucket">bucket</h2>
<pre class="highlight javascript tab-javascript"><code><span class="s2">"bucket"</span><span class="p">:</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">"min"</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="s2">"max"</span><span class="p">:</span> <span class="mi">100</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre>
<p>Bucket selection is one of the most basic forms of traffic splitting. It allows the splitter to send percentages of traffic to different upstreams.</p>

<p>The bucketing system works by issuing a browser identifier cookie (name and lifespan <a href="#browserid">configurable</a>) with random sequence of characters (12 by default). The cookie is only issued once, which the splitter then uses to calculate the bucket (from 0 to 100). Meaning that, once a user was assigned a bucket, it will always be &ldquo;inside&rdquo; that bucket (unless cookies are deleted).</p>

<h2 id="cookie">cookie</h2>
<pre class="highlight javascript tab-javascript"><code><span class="s2">"cookie"</span><span class="p">:</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"amIallowed"</span><span class="p">,</span>
    <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"yes"</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre>
<p>Matches against the request cookies.</p>

<p><a href="#criteria">Remember</a> that only one cookie needs to be matched for the condition to be valid!</p>

<h2 id="device">device</h2>

<p>Device detection is achieved using the <a href="https://www.npmjs.com/package/mobile-detect">mobile-detect</a> package, which is based on the user-agent header.</p>
<pre class="highlight javascript tab-javascript"><code><span class="s2">"device"</span><span class="p">:</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">"device"</span><span class="p">:</span> <span class="s2">"tablet"</span><span class="p">,</span>
    <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"ipad"</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="s2">"device"</span><span class="p">:</span> <span class="s2">"desktop"</span><span class="p">,</span>
    <span class="s2">"browser"</span><span class="p">:</span> <span class="s2">"Firefox"</span><span class="p">,</span>
    <span class="s2">"version"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"from"</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span>
      <span class="s2">"to"</span><span class="p">:</span> <span class="mi">37</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre>
<h3 id="options">Options</h3>

<p><strong>device</strong> - &ldquo;desktop&rdquo;, &ldquo;phone&rdquo;, &ldquo;tablet&rdquo;, &ldquo;mobile&rdquo;. &ldquo;mobile&rdquo; will match both tablets and phones.</p>

<p><strong>type</strong> - only relevant when device is set to either phone, tablet or mobile. It provides the type of device.</p>

<p><strong>browser</strong> - any browser</p>

<p><strong>version</strong> - version of browser with the ability to limit the version by specifying a &ldquo;from&rdquo; and &ldquo;to&rdquo;. Either from or to can be omitted to leave the lower/upper boundary open.</p>

<p>Check the package <a href="http://hgoebl.github.io/mobile-detect.js/doc/MobileDetect.html">documentation</a> for the list of device types and browsers.</p>

<h2 id="geoip">geoip</h2>
<pre class="highlight javascript tab-javascript"><code><span class="s2">"geoip"</span><span class="p">:</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">"country"</span><span class="p">:</span> <span class="s2">"US"</span><span class="p">,</span>
    <span class="s2">"region"</span><span class="p">:</span> <span class="s2">"TX"</span><span class="p">,</span>
    <span class="s2">"city"</span><span class="p">:</span> <span class="s2">"San Antonio"</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="s2">"country"</span><span class="p">:</span> <span class="s2">"PT"</span><span class="p">,</span>
    <span class="s2">"region"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
    <span class="s2">"city"</span><span class="p">:</span> <span class="s2">""</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre>
<p><a href="https://www.npmjs.com/package/geoip-lite">geoip-lite</a> package allows traffic splitter to evaluate the location from where the request was made. This package uses the GeoLite database from <a href="https://www.maxmind.com">MaxMind</a>.</p>

<p><br></p>

<p>You can leave any property empty to get a broader area.</p>

<p><br></p>

<p>By default, this uses the IP address from the incoming connection but this can be overridden by passing the ?splitterIP=<IP> parameter on the query string.</p>

<h2 id="host">host</h2>
<pre class="highlight javascript tab-javascript"><code><span class="s2">"host"</span><span class="p">:</span> <span class="p">[</span>
  <span class="s2">"www.mindera.com"</span><span class="p">,</span>
  <span class="s2">"mindera.com"</span><span class="p">,</span>
<span class="p">]</span>
</code></pre>
<p>Evaluates against the host header.</p>

<p>If no such header is provided the condition wont ever be met.</p>

<h2 id="path">path</h2>
<pre class="highlight javascript tab-javascript"><code><span class="s2">"path"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"/home"</span><span class="p">,</span> <span class="s2">"/about"</span><span class="p">,</span> <span class="s2">"/blog"</span><span class="p">]</span>
</code></pre>
<p>Validates against the request path.</p>

<p>For better use of this rule check <a href="#pathregexp">pathRegExp</a>.</p>

<h2 id="visitor">visitor</h2>
<pre class="highlight javascript tab-javascript"><code><span class="s2">"visitor"</span><span class="p">:</span> <span class="kc">true</span>
</code></pre>
<p>User is considered a visitor when request has no cookies.</p>

<h2 id="and">and</h2>
<pre class="highlight javascript tab-javascript"><code><span class="s2">"and"</span><span class="p">:</span> <span class="p">[</span>
  <span class="c1">// insert n rules in here</span>
<span class="p">]</span>
</code></pre>
<p>This rule consists of an array of rules and it will only be true if all rules inside it are also true.</p>

<p>Note that this particular rule is slightly redundant as the splitter already matches rules within in and out sections using the AND approach (all rules must match).</p>

<h2 id="or">or</h2>
<pre class="highlight javascript tab-javascript"><code><span class="s2">"or"</span><span class="p">:</span> <span class="p">[</span>
  <span class="c1">// insert n rules in here</span>
<span class="p">]</span>
</code></pre>
<p>By now we bet you already know how this rule works, right? :)</p>

<p>In case you don&rsquo;t, this rule also consists of an array of rules and it will be true if at least one of the rules inside it is true.</p>

<h2 id="ruleset">ruleset</h2>
<pre class="highlight javascript tab-javascript"><code><span class="s2">"ruleset"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"myRuleset1"</span><span class="p">,</span> <span class="s2">"myRuleset2"</span><span class="p">,</span> <span class="s2">"myRuleset3"</span><span class="p">]</span>
</code></pre>
<p>Check <a href="#rulesets">rulesets configuration</a> to avoid criterias repetition. (this is awesome btw!)</p>

          <h1 id="configuration">Configuration</h1>
<pre class="highlight javascript tab-javascript"><code><span class="c1">// load from json file:</span>
<span class="kr">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">).</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'./conf/config.json'</span><span class="p">))</span>

<span class="c1">// or declare it normally</span>
<span class="kr">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre>
<p>Configuration is an object with several properties (listed below) that will define the splitter behaviour.</p>

<p>Before the server starts, <strong>splitter optimizes the configuration by changing some properties and values</strong> so that the conditions in runtime are faster, mainly when evaluating rules.</p>

<p>You are able to see how your configuration will be with the <a href="#getconfiguration">getConfiguration</a> method.</p>

<p>Look at a minimum configuration example in <a href="#ready-to-go-configuration">here</a>.</p>

<h2 id="api">api</h2>
<pre class="highlight javascript tab-javascript"><code><span class="p">{</span>
  <span class="s2">"serverName"</span><span class="p">:</span> <span class="s2">"Traffic Splitter"</span><span class="p">,</span>
  <span class="s2">"port"</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
  <span class="s2">"maxConnections"</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
  <span class="s2">"upstreamKeepAlive"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"maxSockets"</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="s2">"maxFreeSockets"</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
    <span class="s2">"timeout"</span><span class="p">:</span> <span class="mi">60000</span><span class="p">,</span>
    <span class="s2">"keepAliveTimeout"</span><span class="p">:</span> <span class="mi">30000</span>
  <span class="p">},</span>
  <span class="s2">"emitMetricsInterval"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"http"</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="s2">"https"</span><span class="p">:</span> <span class="mi">10000</span>
  <span class="p">},</span>
  <span class="s2">"performance"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"logSlowRequests"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s2">"slowRequestThreshold"</span><span class="p">:</span> <span class="mi">1000</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>This property is related to the restify instance and agentkeepalive configuration, as well as other values for manipulation of logs and events.</p>

<h3 id="properties">Properties</h3>

<p><strong>serverName</strong> - restify instance name</p>

<p><strong>port</strong> - port for the server: localhost:port</p>

<p><strong>maxConnections</strong> - server maximum connections. Default is 256</p>

<p><strong>upstreamKeepAlive</strong> - configuration for the <a href="#https://www.npmjs.com/package/agentkeepalive">agentkeepalive</a> instance</p>

<p><strong>emitMetricsInterval</strong> - interval in milliseconds to emit the <a href="#httpsocketmetrics">httpSocketMetrics</a> and <a href="#httpssocketmetrics">httpsSocketMetrics</a> events. Default is 5000</p>

<p><strong>performance</strong> - &ldquo;logSlowRequests&rdquo; is a flag to log (or not) slow requests and &ldquo;slowRequestThreshold&rdquo; its the boundary in which a request is considered slow. Example: given the configuration at right, if a request takes 900 milliseconds then is not a slow request, but if it takes 1000 or more milliseconds it is now considered a slow request</p>

<p><br></p>

<p>This is a required property.</p>

<h2 id="bunyan">bunyan</h2>
<pre class="highlight javascript tab-javascript"><code><span class="p">{</span>
  <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"traffic-splitter"</span><span class="p">,</span>
  <span class="s2">"streams"</span><span class="p">:</span> <span class="p">[]</span>
<span class="p">}</span>
</code></pre>
<p>Splitter uses the <a href="https://www.npmjs.com/package/bunyan">bunyan</a> library for logging.</p>

<p>Provide a name for it and 0 or more streams.</p>

<p>In case no streams are provided the splitter will add the stream: { level: &lsquo;info&rsquo;, stream: process.stdout }</p>

<p><br></p>

<p>This is a required property.</p>

<h2 id="browserid">browserId</h2>
<pre class="highlight javascript tab-javascript"><code><span class="p">{</span>
  <span class="s2">"cookie"</span><span class="p">:</span> <span class="s2">"bid"</span><span class="p">,</span>
  <span class="s2">"maxAge"</span><span class="p">:</span> <span class="mi">315360000</span><span class="p">,</span>
  <span class="s2">"length"</span><span class="p">:</span> <span class="mi">12</span>
<span class="p">}</span>
</code></pre>
<p>This property defines the configuration for the browserId cookie emitted by the splitter for <a href="#bucket">bucketing</a> purposes.</p>

<p><br></p>

<p>This is a required property.</p>

<h2 id="domains">domains</h2>
<pre class="highlight javascript tab-javascript"><code><span class="p">[</span>
  <span class="s2">"www.trafficsplitter.io"</span><span class="p">,</span>
  <span class="s2">"www.mindera.com"</span>
<span class="p">]</span>
</code></pre>
<p>Provide a list for the domains that you want to enable splitter to add the <a href="#cors">CORS</a> headers.</p>

<p><br></p>

<p>This is an optional property.</p>

<h2 id="cors">cors</h2>
<pre class="highlight javascript tab-javascript"><code><span class="p">{</span>
  <span class="s2">"headers"</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">"ORIGIN"</span><span class="p">,</span>
    <span class="s2">"X_REQUESTED_WITH"</span><span class="p">,</span>
    <span class="s2">"X-Requested-with"</span><span class="p">,</span>
    <span class="s2">"Content-Type"</span><span class="p">,</span>
    <span class="s2">"Accept"</span>
  <span class="p">],</span>
  <span class="s2">"credentials"</span><span class="p">:</span> <span class="s2">"true"</span><span class="p">,</span>
  <span class="s2">"methods"</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">"GET"</span><span class="p">,</span>
    <span class="s2">"POST"</span><span class="p">,</span>
    <span class="s2">"DELETE"</span><span class="p">,</span>
    <span class="s2">"OPTIONS"</span><span class="p">,</span>
    <span class="s2">"PUT"</span>
  <span class="p">],</span>
  <span class="s2">"max-age"</span><span class="p">:</span> <span class="s2">"600"</span>
<span class="p">}</span>
</code></pre>
<p>Configuration for the CORS headers in case the host belongs to the <a href="#domains">domains</a> list.</p>

<p><br></p>

<p>This is an optional property.</p>

<h2 id="pathregexp">pathRegExp</h2>
<pre class="highlight javascript tab-javascript"><code><span class="p">{</span>
  <span class="s2">"prefix"</span><span class="p">:</span> <span class="s2">"^"</span><span class="p">,</span>
  <span class="s2">"sufix"</span><span class="p">:</span> <span class="s2">"([/?].*)?$"</span>
<span class="p">}</span>
</code></pre>
<p>This property is a plus for the <a href="#path">path</a> criteria. The example at right is the <strong>recommend</strong> definition for this property.</p>

<p>The <a href="#path">path</a> criteria is turned into a regex when splitter optimizes the configuration and this object allows you to set a prefix and sufix to that regex for every path. Let&rsquo;s see why this is useful.</p>

<p>Let&rsquo;s make an example and assume that the path criteria is [&ldquo;/banana&rdquo;].</p>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">expression1</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">"/banana"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">condition1</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">expression1</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">expression2</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">"^"</span> <span class="o">+</span> <span class="s2">"/banana"</span> <span class="o">+</span> <span class="s2">"([/?].*)?$"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">condition2</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">expression2</span><span class="p">)</span>
</code></pre>
<p>Also assume the defined variables at right.</p>

<table><thead>
<tr>
<th style="text-align: left">request.url</th>
<th style="text-align: center">condition1 (without pathRegExp)</th>
<th style="text-align: center">condition2 (with pathRegExp)</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left">/apple</td>
<td style="text-align: center"><img src="images/fail.png" alt="fail" /></td>
<td style="text-align: center"><img src="images/fail.png" alt="fail" /></td>
</tr>
<tr>
<td style="text-align: left">/banana</td>
<td style="text-align: center"><img src="images/success.png" alt="success" /></td>
<td style="text-align: center"><img src="images/success.png" alt="success" /></td>
</tr>
<tr>
<td style="text-align: left">/bananas</td>
<td style="text-align: center"><img src="images/success.png" alt="success" /></td>
<td style="text-align: center"><img src="images/fail.png" alt="fail" /></td>
</tr>
<tr>
<td style="text-align: left">/bananas/1</td>
<td style="text-align: center"><img src="images/success.png" alt="success" /></td>
<td style="text-align: center"><img src="images/fail.png" alt="fail" /></td>
</tr>
<tr>
<td style="text-align: left">/bananas?id=1</td>
<td style="text-align: center"><img src="images/success.png" alt="success" /></td>
<td style="text-align: center"><img src="images/fail.png" alt="fail" /></td>
</tr>
<tr>
<td style="text-align: left">/banana/</td>
<td style="text-align: center"><img src="images/success.png" alt="success" /></td>
<td style="text-align: center"><img src="images/success.png" alt="success" /></td>
</tr>
<tr>
<td style="text-align: left">/banana/1</td>
<td style="text-align: center"><img src="images/success.png" alt="success" /></td>
<td style="text-align: center"><img src="images/success.png" alt="success" /></td>
</tr>
<tr>
<td style="text-align: left">/banana?id=1</td>
<td style="text-align: center"><img src="images/success.png" alt="success" /></td>
<td style="text-align: center"><img src="images/success.png" alt="success" /></td>
</tr>
</tbody></table>

<p>(<a href="https://jsfiddle.net/uqyo484v/1/">run this test</a>)</p>

<p><br></p>

<p>We believe that the correct behaviour is achieved with the condition2 (with pathRegExp), but do what best suits your needs, really :)</p>

<p><br></p>

<p>This is an optional property.</p>

<h2 id="rulesets">rulesets</h2>
<pre class="highlight javascript tab-javascript"><code><span class="p">{</span>
  <span class="s2">"myRuleset1"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"cookie"</span><span class="p">:</span> <span class="p">[{</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"step"</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"in"</span> <span class="p">}],</span>
    <span class="s2">"path"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"/blog"</span><span class="p">,</span> <span class="s2">"/people-and-culture"</span><span class="p">,</span> <span class="s2">"/case-studie"</span><span class="p">],</span>
    <span class="s2">"agent"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Chrome"</span><span class="p">,</span> <span class="s2">"Safari"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// inside some upstream</span>
<span class="nl">in</span><span class="p">:</span> <span class="p">{</span>
  <span class="nl">ruleset</span><span class="p">:</span> <span class="p">[</span><span class="s2">"myRuleset1"</span><span class="p">],</span>
  <span class="nx">bucket</span><span class="p">:</span> <span class="p">[{</span> <span class="s2">"min"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"max"</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}]</span>
<span class="p">}</span>

<span class="c1">// inside some other upstream</span>
<span class="nl">in</span><span class="p">:</span> <span class="p">{</span>
  <span class="nl">ruleset</span><span class="p">:</span> <span class="p">[</span><span class="s2">"myRuleset1"</span><span class="p">],</span>
  <span class="nx">bucket</span><span class="p">:</span> <span class="p">[{</span> <span class="s2">"min"</span><span class="p">:</span> <span class="mi">51</span><span class="p">,</span> <span class="s2">"max"</span><span class="p">:</span> <span class="mi">100</span> <span class="p">}]</span>
<span class="p">}</span>
</code></pre>
<p>This is one hell of a property! Its very useful to avoid repetition of criterias accross the upstreams.</p>

<p>Picture yourself having two upstreams with 10 criterias each (for the &lsquo;in&rsquo; part). And in those 10, only one of them is different. Quite boring and repetitive right? Well, just create a ruleset with whatever name you want containing all those 9 equal criteria. And then, back in each upstream delete the criteria that is repeated and add the criteria <a href="#ruleset">ruleset</a>.</p>

<p>Just check the example at right.</p>

<p><br></p>

<h3 id="notes">Notes:</h3>

<ul>
<li><p>You can have multiple rulesets for each upstream</p></li>
<li><p>If an upstream has a criteria that is also defined in a ruleset used by the same upstream, the one that&rsquo;s taking effect is the one that was last declared</p></li>
</ul>

<p><br></p>

<p>This is an optional property.</p>

<h2 id="upstreams">upstreams</h2>
<pre class="highlight javascript tab-javascript"><code><span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"mindera &lt;3"</span><span class="p">,</span>
    <span class="s2">"enabled"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s2">"criteria"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"in"</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1">// your criteria to allow access in here</span>
      <span class="p">},</span>
      <span class="s2">"out"</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1">// your criteria to deny access in here</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">"upstream"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"serveSecure"</span><span class="p">,</span>
      <span class="s2">"options"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"host"</span><span class="p">:</span> <span class="s2">"www.mindera.com"</span><span class="p">,</span>
        <span class="s2">"port"</span><span class="p">:</span> <span class="mi">443</span><span class="p">,</span>
        <span class="s2">"headers"</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">"host"</span><span class="p">:</span> <span class="s2">"www.mindera.com"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre>
<p>This is the most interesting part :D</p>

<p>It&rsquo;s this property that contains the array with all the upstreams that you want your splitter to use, just like in the <a href="#example">example</a>.</p>

<p><br></p>

<p>This is a required property.</p>

          <h1 id="methods">Methods</h1>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">TrafficSplitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'traffic-splitter'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">splitter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TrafficSplitter</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
</code></pre>
<p>Splitter provides some methods to help you take more advantage of its features.</p>

<p>Besides the <a href="#isConfigurationValid">isConfigurationValid</a> all the methods are at instance level.</p>

<h2 id="isconfigurationvalid">isConfigurationValid</h2>
<pre class="highlight javascript tab-javascript"><code><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">TrafficSplitter</span><span class="p">.</span><span class="nx">isConfigurationValid</span><span class="p">(</span><span class="nx">myConfig</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'My configuration is invalid!'</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
<p>This method returns a boolean and tells you if your configuration has the necessary objets and properties to start.</p>

<h2 id="getconfiguration">getConfiguration</h2>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">optimizedConfiguration</span> <span class="o">=</span> <span class="nx">splitter</span><span class="p">.</span><span class="nx">getConfiguration</span><span class="p">()</span>
</code></pre>
<p>Splitter provides a method that returns the configuration after the optimizations were made.</p>

<h2 id="getlogger">getLogger</h2>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">splitter</span><span class="p">.</span><span class="nx">getLogger</span><span class="p">()</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">'Gotta love this!'</span><span class="p">)</span>

<span class="c1">// {"name":"traffic-splitter","hostname":"unknown","pid":13360,"level":30,"msg":"Gotta love this!","time":"2017-06-01T15:56:05.897Z","v":0}</span>
</code></pre>
<p>This method is at instance level and it returns its bunyan instance so you can use it.</p>

<p><a href="https://www.npmjs.com/package/bunyan">Bunyan</a> is a simple and fast JSON logging library.</p>

<h2 id="bootstrap">bootstrap</h2>
<pre class="highlight javascript tab-javascript"><code><span class="nx">splitter</span><span class="p">.</span><span class="nx">bootstrap</span><span class="p">((</span><span class="nx">server</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// this code will be executed before the server starts</span>
  <span class="c1">// do whatever you want/need in here</span>
<span class="p">})</span>
</code></pre>
<p>This method allows you to run some code before the server starts.</p>

<p>It takes a callback with two parameters:</p>

<p><strong>server</strong> - restify instance</p>

<p><strong>config</strong> - optimized configuration</p>

<h2 id="use">use</h2>
<pre class="highlight javascript tab-javascript"><code><span class="nx">splitter</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">server</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`Request URL = </span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>
<span class="p">})</span>
</code></pre>
<p>This method allows you to add middlewares to the server. It will be executed once per request.</p>

<p>It takes the same parameter as the previous method but this callback should return another callback that it will be called by the server.</p>

<p>Inside the callback returned always do &ldquo;return next()&rdquo; (or similar) or the request will get stuck in it.</p>

<h2 id="addrule">addRule</h2>
<pre class="highlight javascript tab-javascript"><code><span class="c1">// somewhere in your upstreams criteria configuration:</span>
<span class="s2">"in"</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// or "out"</span>
  <span class="s2">"myCustomRule1"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"even"</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="s2">"host"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"myHost.com"</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1">// evaluating custom rule</span>
<span class="nx">splitter</span><span class="p">.</span><span class="nx">addRule</span><span class="p">(</span><span class="s1">'myCustomRule1'</span><span class="p">,</span> <span class="p">(</span><span class="nx">criteria</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">currentMinute</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getMinutes</span><span class="p">()</span>
  <span class="kr">const</span> <span class="nx">isEven</span> <span class="o">=</span> <span class="nx">currentMinute</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="nx">criteria</span> <span class="p">?</span> <span class="nx">isEven</span> <span class="p">:</span> <span class="o">!</span><span class="nx">isEven</span>
<span class="p">})</span>

<span class="c1">// overriding splitter rule</span>
<span class="nx">splitter</span><span class="p">.</span><span class="nx">addRule</span><span class="p">(</span><span class="s1">'host'</span><span class="p">,</span> <span class="p">(</span><span class="nx">criteria</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nx">criteria</span> <span class="o">===</span> <span class="s1">'myHost.com'</span>
<span class="p">})</span>
</code></pre>
<p>This is maybe the coolest feature of the splitter, it allows you to evaluate your custom rules in a very simplistic way.</p>

<p><br></p>

<p>And it also gives you the chance to override any splitter default rule evaluation in case you need to adjust it for your needs.</p>

<p><br></p>

<p>It takes two parameters. First is the name of your rule (in the configuration) and second is a callback that takes two parameters as well (first will be the rule object and second the current request). This callback must return a boolean.</p>

<p><br></p>

<p>Note: missing methods to evaluate custom rules or those who won&rsquo;t return a boolean will be ignored.</p>

          <h1 id="events">Events</h1>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">TrafficSplitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'traffic-splitter'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">splitter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TrafficSplitter</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">splitter</span><span class="p">.</span><span class="nx">getLogger</span><span class="p">()</span>
</code></pre>
<p>During its life splitter emits several events which you can listen to.</p>

<h2 id="applicationstart">applicationStart</h2>
<pre class="highlight javascript tab-javascript"><code><span class="nx">splitter</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'applicationStart'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">'Application has started'</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
<p>Emitted when splitter.start() is called, which is after optimizing the given configuration.</p>

<h2 id="serverstart">serverStart</h2>
<pre class="highlight javascript tab-javascript"><code><span class="nx">splitter</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'serverStart'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">'Server has started'</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
<p>Triggered after server is configured and started, and also after executing <a href="#bootstrap">bootstrap functions</a>.</p>

<h2 id="rulesprocessing">rulesProcessing</h2>
<pre class="highlight javascript tab-javascript"><code><span class="nx">splitter</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'rulesProcessing'</span><span class="p">,</span> <span class="p">(</span><span class="nx">duration</span><span class="p">,</span> <span class="nx">selectedUpstream</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`Rules processed in </span><span class="p">${</span><span class="nx">duration</span><span class="p">}</span><span class="s2"> milliseconds`</span><span class="p">)</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`Selected upstream =  </span><span class="p">${</span><span class="nx">selectedUpstream</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
<p>Called each time a request is made.</p>

<p>It tells you the time it took to calculate the upstream (in milliseconds) and also the selected upstream name.</p>

<h2 id="noupstreamfound">noUpstreamFound</h2>
<pre class="highlight javascript tab-javascript"><code><span class="nx">splitter</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'noUpstreamFound'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`No upstream found for request </span><span class="p">${</span><span class="nx">req</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
<p>Only emitted when no upstream matched the given request.</p>

<h2 id="resfinish">resFinish</h2>
<pre class="highlight javascript tab-javascript"><code><span class="nx">splitter</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'resFinish'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">duration</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`Response finished in </span><span class="p">${</span><span class="nx">duration</span><span class="p">}</span><span class="s2"> milliseconds`</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
<p>Triggered every time a response is sent to the final user.</p>

<h2 id="serving">serving</h2>
<pre class="highlight javascript tab-javascript"><code><span class="nx">splitter</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'serving'</span><span class="p">,</span> <span class="p">(</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">upstream</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">host</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">host</span><span class="p">}</span><span class="s2"> took </span><span class="p">${</span><span class="nx">duration</span><span class="p">}</span><span class="s2"> milliseconds to respond with </span><span class="p">${</span><span class="nx">statusCode</span><span class="p">}</span><span class="s2"> HTTP code`</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
<p>Called each time an upstream response arrives (only for serve and serveSecure types).</p>

<h2 id="servingerror">servingError</h2>
<pre class="highlight javascript tab-javascript"><code><span class="nx">splitter</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'servingError'</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">upstream</span><span class="p">,</span> <span class="nx">duration</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`Error while serving upstream '</span><span class="p">${</span><span class="nx">upstream</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">':`</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
<p>Triggered when an upstream responds with an error.</p>

<h2 id="upstreamexception">upstreamException</h2>
<pre class="highlight javascript tab-javascript"><code><span class="nx">splitter</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'upstreamException'</span><span class="p">,</span> <span class="p">(</span><span class="nx">exception</span><span class="p">,</span> <span class="nx">upstream</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`Upstream (</span><span class="p">${</span><span class="nx">upstream</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">) exception: </span><span class="p">${</span><span class="nx">exception</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
<p>Emitted when an error is catched while executing an upstream.</p>

<h2 id="httpsocketmetrics">httpSocketMetrics</h2>
<pre class="highlight javascript tab-javascript"><code><span class="nx">splitter</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'httpSocketMetrics'</span><span class="p">,</span> <span class="p">(</span><span class="nx">agentStatus</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">'HTTP socket metrics: '</span><span class="p">,</span> <span class="nx">agentStatus</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">// {"name":"traffic-splitter","hostname":"unknown","pid":14328,"level":30,"msg":"HTTP socket metrics:  { createSocketCount: 0,\n  createSocketErrorCount: 0,\n  closeSocketCount: 0,\n  errorSocketCount: 0,\n  timeoutSocketCount: 0,\n  requestCount: 0,\n  freeSockets: {},\n  sockets: {},\n  requests: {} }","time":"2017-06-03T19:50:33.799Z","v":0}</span>
</code></pre>
<p>Triggered each <a href="#api">emitMetricsInterval.http</a> milliseconds when at least one serve upstream type is present in the configuration.</p>

<p>It gives you the <a href="https://www.npmjs.com/package/agentkeepalive">agentkeepalive</a> instance current status.</p>

<h2 id="httpssocketmetrics">httpsSocketMetrics</h2>
<pre class="highlight javascript tab-javascript"><code><span class="nx">splitter</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'httpsSocketMetrics'</span><span class="p">,</span> <span class="p">(</span><span class="nx">agentStatus</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">'HTTPS socket metrics: '</span><span class="p">,</span> <span class="nx">agentStatus</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
<p>Works the same way <a href="#httpsocketmetrics">httpSocketMetrics</a> does but for the serveSecure upstream type.</p>

<h2 id="redirecting">redirecting</h2>
<pre class="highlight javascript tab-javascript"><code><span class="nx">splitter</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'redirecting'</span><span class="p">,</span> <span class="p">(</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">upstream</span><span class="p">,</span> <span class="nx">duration</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`Redirecting to upstream '</span><span class="p">${</span><span class="nx">upstream</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">' took </span><span class="p">${</span><span class="nx">duration</span><span class="p">}</span><span class="s2"> milliseconds with the HTTP code </span><span class="p">${</span><span class="nx">statusCode</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
<p>Emitted every time a request is redirected (consequence of the <a href="#redirect">redirect</a> upstream type).</p>

          <h1 id="debugging">Debugging</h1>
<pre class="highlight javascript tab-javascript"><code><span class="nx">Request</span><span class="p">:</span>
  <span class="nx">curl</span>
    <span class="o">--</span><span class="nx">user</span><span class="o">-</span><span class="nx">agent</span> <span class="s2">"Mozilla/5.0 (iPhone; CPU iPhone OS 10_0 like Mac OS X) AppleWebKit/602.1.38 (KHTML, like Gecko) Version/10.0 Mobile/14A5297c Safari/602.1"</span>
    <span class="o">-</span><span class="nx">G</span> <span class="nx">localhost</span>
    <span class="o">-</span><span class="nx">d</span> <span class="nx">splitterIP</span><span class="o">=</span><span class="mf">195.245</span><span class="p">.</span><span class="mf">151.210</span>
    <span class="o">-</span><span class="nx">d</span> <span class="nx">splitterDebug</span><span class="o">=</span><span class="kc">true</span>
    <span class="o">-</span><span class="nx">v</span>

<span class="nx">Response</span> <span class="nx">debugging</span> <span class="nx">headers</span><span class="p">:</span>
  <span class="nx">x</span><span class="o">-</span><span class="nx">splitter</span><span class="o">-</span><span class="nx">upstream</span><span class="p">:</span> <span class="s2">"debugging"</span>
  <span class="nx">x</span><span class="o">-</span><span class="nx">splitter</span><span class="o">-</span><span class="nx">geo</span><span class="p">:</span> <span class="s2">"PT.17.Porto"</span>
  <span class="nx">x</span><span class="o">-</span><span class="nx">splitter</span><span class="o">-</span><span class="nx">device</span><span class="p">:</span> <span class="p">{</span><span class="s2">"ua"</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (iPhone; CPU iPhone OS 10_0 like Mac OS X) AppleWebKit/602.1.38 (KHTML, like Gecko) Version/10.0 Mobile/14A5297c Safari/602.1"</span><span class="p">,</span><span class="s2">"_cache"</span><span class="p">:{</span><span class="s2">"phone"</span><span class="p">:</span><span class="s2">"iPhone"</span><span class="p">,</span><span class="s2">"mobile"</span><span class="p">:</span><span class="s2">"iPhone"</span><span class="p">,</span><span class="s2">"tablet"</span><span class="p">:</span><span class="kc">null</span><span class="p">},</span><span class="s2">"maxPhoneWidth"</span><span class="p">:</span><span class="mi">600</span><span class="p">}</span>
  <span class="nx">x</span><span class="o">-</span><span class="nx">splitter</span><span class="o">-</span><span class="nx">bucket</span><span class="p">:</span> <span class="mi">66</span>
</code></pre>
<p>Pass the ?splitterDebug=true parameter to obtain debug information in the response headers about the criteria selection.</p>

<h3 id="provided-headers">Provided headers</h3>

<p><strong>x-splitter-upstream</strong> - selected upstream name</p>

<p><strong>x-splitter-geo</strong>* - geoip information</p>

<p><strong>x-splitter-device</strong>* - device information</p>

<p><strong>x-splitter-bucket</strong>* - assigned bucket</p>

<p>* - only available if selected upstream has the respective rule</p>

          <h1 id="ready-to-go-configuration">Ready to go configuration</h1>
<pre class="highlight javascript tab-javascript"><code><span class="p">{</span>
  <span class="s2">"api"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"serverName"</span><span class="p">:</span> <span class="s2">"traffic-splitter"</span><span class="p">,</span>
    <span class="s2">"port"</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
    <span class="s2">"maxConnections"</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="s2">"upstreamKeepAlive"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"maxSockets"</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
      <span class="s2">"maxFreeSockets"</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
      <span class="s2">"timeout"</span><span class="p">:</span> <span class="mi">60000</span><span class="p">,</span>
      <span class="s2">"keepAliveTimeout"</span><span class="p">:</span> <span class="mi">30000</span>
    <span class="p">},</span>
    <span class="s2">"emitMetricsInterval"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"http"</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
      <span class="s2">"https"</span><span class="p">:</span> <span class="mi">10000</span>
    <span class="p">},</span>
    <span class="s2">"performance"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"logSlowRequest"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="s2">"slowRequestThreshold"</span><span class="p">:</span> <span class="mi">2500</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">"bunyan"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"traffic-splitter"</span><span class="p">,</span>
    <span class="s2">"streams"</span><span class="p">:</span> <span class="p">[]</span>
  <span class="p">},</span>
  <span class="s2">"browserId"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"cookie"</span><span class="p">:</span> <span class="s2">"bid"</span><span class="p">,</span>
    <span class="s2">"maxAge"</span><span class="p">:</span> <span class="mi">315360000</span><span class="p">,</span>
    <span class="s2">"length"</span><span class="p">:</span> <span class="mi">12</span>
  <span class="p">},</span>
  <span class="s2">"pathRegExp"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"prefix"</span><span class="p">:</span> <span class="s2">"^"</span><span class="p">,</span>
    <span class="s2">"sufix"</span><span class="p">:</span> <span class="s2">"([/?].*)?$"</span>
  <span class="p">},</span>
  <span class="s2">"upstreams"</span><span class="p">:</span> <span class="p">[</span>
    <span class="c1">// your upstreams in here</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre>
<p>Use this configuration sample as you want.</p>

<p>Add some upstreams as seen in <a href="#upstreams">here</a> to the upstreams array.</p>

<p>After that you&rsquo;re ready to rock and split!</p>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="node.js">node.js</a>
          </div>
      </div>
    </div>
  </body>
</html>
